@model MedicalTriageSystem.Models.Patient

@{
    ViewData["Title"] = "Détails du Patient";
}

<h1>Détails du Patient</h1>

<div>
    <h4>Patient</h4>
    <hr />
    <dl class="row">
        <dt class="col-sm-2">
            @Html.DisplayNameFor(model => model.Name)
        </dt>
        <dd class="col-sm-10">
            @Html.DisplayFor(model => model.Name)
        </dd>

        <dt class="col-sm-2">
            @Html.DisplayNameFor(model => model.Age)
        </dt>
        <dd class="col-sm-10">
            @Html.DisplayFor(model => model.Age)
        </dd>

        <dt class="col-sm-2">
            @Html.DisplayNameFor(model => model.Email)
        </dt>
        <dd class="col-sm-10">
            @Html.DisplayFor(model => model.Email)
        </dd>

        <dt class="col-sm-2">
            @Html.DisplayNameFor(model => model.Phone)
        </dt>
        <dd class="col-sm-10">
            @Html.DisplayFor(model => model.Phone)
        </dd>

        <dt class="col-sm-2">
            Dernier Triage
        </dt>
        <dd class="col-sm-10">
            @{
                // ✅ CORRECTION : Utiliser CreatedAt au lieu de Date
                var lastTriage = Model.TriageResults?.OrderByDescending(t => t.CreatedAt).FirstOrDefault();
                var triageLevel = lastTriage?.Level ?? "Non évalué";
                var triageScore = lastTriage?.Score ?? 0;
            }

            @if (lastTriage != null)
            {
                <div class="card mb-3">
                    <div class="card-header bg-info text-white">
                        Résultat du Triage
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-4">
                                <strong>Niveau:</strong>
                                <span class="badge @(triageLevel == "Urgent" ? "bg-danger" :
                                                                                                                    triageLevel == "High" ? "bg-warning" :
                                                                                                                    triageLevel == "Normal" ? "bg-info" :
                                                                                                                    triageLevel == "Low" ? "bg-success" : "bg-secondary")">
                                @triageLevel
                            </span>
                        </div>
                        <div class="col-md-4">
                            <strong>Score:</strong> @triageScore
                        </div>
                        <div class="col-md-4">
                            <strong>Date:</strong> @lastTriage.CreatedAt.ToString("dd/MM/yyyy HH:mm")
                        </div>
                    </div>
                    @if (!string.IsNullOrEmpty(lastTriage.Recommendation))
                        {
                            <div class="mt-3">
                                <strong>Recommandation:</strong>
                                <p class="mt-1">@lastTriage.Recommendation</p>
                            </div>
                        }
                    </div>
                </div>
            }
            else
            {
                <span class="text-muted">Aucun triage effectué</span>
            }
        </dd>

        <!-- Symptômes -->
        @if (Model.Symptoms?.Any() == true)
        {
            <dt class="col-sm-2">
                Symptômes
            </dt>
            <dd class="col-sm-10">
                <ul class="list-group">
                    @foreach (var symptom in Model.Symptoms)
                    {
                        <li class="list-group-item">
                            <strong>@symptom.Description</strong> - <!-- CHANGÉ: Description au lieu de Name -->
                            Sévérité: @symptom.Severity -
                            <small class="text-muted">@symptom.Date.ToString("dd/MM/yyyy")</small> <!-- CHANGÉ: StartDate au lieu de Date -->
                        </li>
                    }
                </ul>
            </dd>
        }
    </dl>
</div>
<div>
    <a asp-action="Edit" asp-route-id="@Model?.Id" class="btn btn-primary">Modifier</a>
    <a asp-action="Index" class="btn btn-secondary">Retour à la liste</a>
</div>